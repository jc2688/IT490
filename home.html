<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Scene Sync Home</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-container"></div>
    <br>
    
    <div id="welcomeMessage"></div>

    <div id="recommendations">
        <!-- Recommendations will be dynamically added here -->
    </div>

    <script>
        const navbarContainer = document.getElementById('navbar-container');
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'components/navbar.html', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                navbarContainer.innerHTML = xhr.responseText;
                validateSession();
                loadRecommendations();
            }
        };
        xhr.send();

        const sessionid = ('; ' + document.cookie).split('; sessionid=').pop().split(';')[0];
        const username = ('; ' + document.cookie).split('; username=').pop().split(';')[0];
        let sessionData = {
            sessionid: sessionid
        };

        function validateSession() {
            sessionData.type = "validate_session";

            $.ajax({
                url: 'sessionValidate.php',
                method: 'POST',
                data: sessionData,
                dataType: 'json',
                success: function (result) {
                    if (result.returnCode != "1") {
                        document.cookie = "sessionid=;username=;path='/'";
                        location.href = "index.html";
                    }
                },
                error: function () {
                    console.log("Error validating session");
                }
            });
        }

        function goToProfile() {
            location.href = "profile.php?u=" + encodeURIComponent(username);
        }

        function logout() {
            sessionData.type = "logout";

            $.ajax({
                url: 'sessionValidate.php',
                method: 'POST',
                data: sessionData,
                success: function () {
                    document.cookie = "sessionid=;path='/'";
                    document.cookie = "username=;path='/'";
                    location.href = "index.html";
                },
                error: function () {
                    console.log("Error logging out");
                }
            });
        }

        function setWelcomeMessage() {
            let welcomeMessage = document.getElementById("welcomeMessage");
            welcomeMessage.innerHTML = `Welcome, ${username} to Scene Sync! Try and find some movies you'd like based on ur preferences.`;
        }

        function loadRecommendations() {
            $.ajax({
                url: 'RabbitMQ/getRecommendations.php',
                method: 'GET',
                dataType: 'json',
                success: function (result) {
                    if (result.length > 0) {
                        let recommendationsContainer = document.getElementById("recommendations");

                        result.forEach(movie => {
                            let movieContainer = document.createElement('div');
                            movieContainer.classList.add('movie');

                            let titleElement = document.createElement('h2');
                            titleElement.innerHTML = `<a href="movieDetails.php?id=${movie.id}">${movie.title}</a>`;

                            let ratingElement = document.createElement('p');
                            ratingElement.textContent = `Rating: ${movie.rating}`;
                            let reviewElement = document.createElement('p');
                            reviewElement.textContent = movie.review;

                            movieContainer.appendChild(titleElement);
                            movieContainer.appendChild(ratingElement);
                            movieContainer.appendChild(reviewElement);

                            let reviewsContainer = document.createElement('div');
                            reviewsContainer.classList.add('reviews');

                            $.ajax({
                                url: 'RabbitMQ/getReviews.php',
                                method: 'GET',
                                data: { movieTitle: movie.title },
                                dataType: 'json',
                                success: function (reviews) {
                                    if (reviews.length > 0) {
                                        reviews.forEach(review => {
                                            let reviewContainer = document.createElement('div');
                                            reviewContainer.classList.add('review');

                                            let blurbElement = document.createElement('p');
                                            blurbElement.textContent = `Blurb: ${review.blurb}`;
                                            let scoreElement = document.createElement('p');
                                            scoreElement.textContent = `Score: ${review.score}`;
                                            let usernameElement = document.createElement('p');
                                            usernameElement.textContent = `Username: ${review.username}`;

                                            reviewContainer.appendChild(blurbElement);
                                            reviewContainer.appendChild(scoreElement);
                                            reviewContainer.appendChild(usernameElement);

                                            reviewsContainer.appendChild(reviewContainer);
                                        });
                                    } else {
                                        let noReviewsElement = document.createElement('p');
                                        noReviewsElement.textContent = 'No reviews available.';
                                        reviewsContainer.appendChild(noReviewsElement);
                                    }
                                },
                                error: function () {
                                    console.log(`Error loading reviews for ${movie.title}`);
                                }
                            });

                            movieContainer.appendChild(reviewsContainer);
                            recommendationsContainer.appendChild(movieContainer);
                        });
                    }
                },
                error: function () {
                    console.log("Error loading recommendations");
                }
            });
        }

        setWelcomeMessage();
    </script>
</body>
</html>
